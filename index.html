<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ADMIN | Preorder Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* CORE CSS */
    :root {
      --bg-body: #f3f4f6; --text-dark: #2d3436; --font-main: 'Poppins', sans-serif; --font-mono: 'JetBrains Mono', monospace;
      --grad-green: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      --grad-orange: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
      --grad-red: linear-gradient(135deg, #ff7675 0%, #E91E63 100%); 
      --grad-blue: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
      --grad-purple: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--bg-body); color: var(--text-dark); font-family: var(--font-main); min-height: 100vh; padding-bottom: 80px; }
    
    /* HEADER & LAYOUT */
    .app-header { position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1.5rem; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.05); color: var(--text-dark); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    .header-left { display: flex; align-items: center; gap: 12px; position: relative; z-index: 2; }
    .logo-img { width: 35px; height: 35px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); object-fit: cover; background: #fff; }
    .logo-container { display: flex; flex-direction: column; justify-content: center; }
    .logo { font-family: var(--font-mono); font-weight: 700; font-size: 1rem; letter-spacing: -0.5px; line-height: 1; color: #0984e3; }
    .meta-bar { font-size: 0.55rem; font-weight: 600; letter-spacing: 1.5px; opacity: 0.6; text-transform: uppercase; margin-top: 2px; }
    .header-actions { display: flex; align-items: center; gap: 10px; z-index: 10; margin-left: auto; }
    .status-pill { position: relative; z-index: 2; font-size: 0.65rem; font-weight: 700; color: #0984e3; display: flex; align-items: center; gap: 6px; background: rgba(9, 132, 227, 0.08); padding: 6px 14px; border-radius: 30px; border: 1px solid rgba(9, 132, 227, 0.1); }
    .pulsing-dot { width: 6px; height: 6px; background: #0984e3; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    
    .main-layout { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; max-width: 1600px; margin: 0 auto; width: 100%; padding: 2rem; padding-bottom: 100px; }
    @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; padding: 1rem; gap: 1.5rem; padding-bottom: 100px; } .app-header { padding: 0.5rem 1rem; } }
    
    /* CARDS & INPUTS */
    .gold-card, .stat-card { border-radius: 24px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; overflow: visible; color: white; transition: transform 0.3s ease; border: none; }
    .gold-card-bg { position: absolute; inset:0; overflow: hidden; border-radius: 24px; z-index: 0; }
    .gold-card:hover, .stat-card:hover { transform: translateY(-5px); }
    aside .gold-card:nth-of-type(1) { background: var(--grad-purple); } aside .gold-card:nth-of-type(2) { background: var(--grad-green); } aside .gold-card:nth-of-type(3) { background: var(--grad-orange); }
    
    /* STATS GRID (HOME VIEW) */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .stats-grid .stat-card:nth-child(1) { background: var(--grad-blue); } .stats-grid .stat-card:nth-child(2) { background: var(--grad-purple); } .stats-grid .stat-card:nth-child(3) { background: var(--grad-red); } .stats-grid .stat-card:nth-child(4) { background: var(--grad-orange); } .stats-grid .stat-card:nth-child(5) { background: var(--grad-green); }
    .stat-title { opacity: 0.9; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; position: relative; z-index: 2; }
    .stat-value { font-size: 1.6rem; font-weight: 800; margin-top: 5px; position: relative; z-index: 2; }
    .wm-sidebar { position: absolute; bottom: -10px; right: -10px; font-size: 90px; color: rgba(255,255,255,0.15); transform: rotate(-10deg); pointer-events: none; z-index: 1; }
    .wm-stat { position: absolute; bottom: -15px; right: -10px; font-size: 80px; color: rgba(255,255,255,0.15); transform: rotate(-10deg); pointer-events: none; z-index: 1; }
    
    /* FORM ELEMENTS */
    .input-group { position: relative; margin-bottom: 12px; z-index: 2; }
    .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.9); font-size: 0.9rem; pointer-events: none; z-index: 3; }
    .clear-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: #ff7675; font-size: 1rem; cursor: pointer; z-index: 10; display: none; transition: 0.2s; }
    .input-arrow { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.6); font-size: 0.8rem; pointer-events: none; z-index: 3; }
    .gold-input, .gold-select { width: 100%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 12px 12px 42px; border-radius: 12px; font-family: var(--font-main); font-size: 0.85rem; backdrop-filter: blur(5px); transition: all 0.25s ease; }
    .gold-select { appearance: none; -webkit-appearance: none; cursor: pointer; }
    .gold-select option { color: #333; background: #fff; padding: 10px; }
    .form-label { font-size: 0.7rem; color: rgba(255,255,255,0.95); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 6px; letter-spacing: 0.5px; position: relative; z-index: 2;}
    .btn-gold { width: 100%; background: white; color: #333; border: none; padding: 14px; border-radius: 12px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-transform: uppercase; transition: transform 0.2s; position: relative; z-index: 2; }
    
    /* ORDER CARDS */
    .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
    .order-card { border-radius: 24px; border: none; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.08); position: relative; overflow: hidden; color: white; height: 100%; }
    .order-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    .card-paid { background: var(--grad-green); } .card-pending { background: var(--grad-red); } .card-error { background: var(--grad-red); } .card-queues { background: var(--grad-purple); }
    .head-echo { position: absolute; right: -10px; top: -10px; font-size: 90px; color: rgba(255,255,255,0.15); transform: rotate(15deg); pointer-events: none; z-index: 0; }
    .card-content { position: relative; z-index: 2; padding: 1.5rem; height: 100%; display: flex; flex-direction: column; }
    .card-head { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; margin-bottom: 15px; position: relative; z-index: 1; }
    .card-id { font-family: monospace; font-weight: 800; cursor: pointer; text-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: color 0.2s;}
    .card-badge { background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 8px; font-size: 0.65rem; font-weight: 700; backdrop-filter: blur(4px); margin-bottom: 4px; display: inline-block; }
    .glass-panel { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; margin-bottom: 10px; backdrop-filter: blur(4px); }
    .prod-name { font-size: 1rem; font-weight: 700; line-height: 1.3; display: flex; align-items: center; gap: 8px; }
    .deal-tag { font-size: 0.65rem; opacity: 0.9; margin-top: 4px; display: block; }
    .money-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
    .total-row { border-top: 1px dashed rgba(255,255,255,0.4); margin-top: 8px; padding-top: 8px; font-size: 1.1rem; font-weight: 800; display: flex; justify-content: space-between; }
    .date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.75rem; }
    .date-item span { display: block; font-size: 0.6rem; opacity: 0.8; text-transform: uppercase; font-weight: 700; }
    .date-item div { font-family: monospace; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .memo-text { font-size: 0.75rem; font-style: italic; display: flex; gap: 6px; }
    .action-row { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px; gap: 8px; flex-wrap: wrap; }
    .icon-group { display: flex; gap: 8px; align-items: center; }
    .status-pill-card { background: white; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.15); white-space: nowrap; }
    .text-paid { color: #00b894; } .text-pend { color: #d63031; } .text-err { color: #d63031; } .text-queues { color: #6c5ce7; }
    .link-btn-external { text-decoration: none; background: #fff; padding: 8px 15px; border-radius: 20px; color: #2d3436; font-size: 0.7rem; font-weight: 800; text-align: center; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); white-space: nowrap; }
    .btn-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; border: none; font-size: 1rem; transition: transform 0.2s; text-decoration: none; }
    .btn-icon:hover { transform: scale(1.1); background: #f9f9f9; }
    .btn-wa-icon { color: #25D366; } .btn-edit-icon { color: #636e72; } .btn-edit-icon:hover { color: #0984e3; }
    
    /* MODALS & ALERTS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-overlay.active { display: flex; }
    .modal-box { background: #fff; width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .modal-title { color: #2d3436; font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-btn-row { display: flex; gap: 10px; margin-top: 20px; }
    .modal-save { flex: 1; background: var(--grad-green); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .modal-cancel { flex: 1; background: #f3f4f6; color: #2d3436; border: none; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .toast-box { position: fixed; top: 25px; right: 25px; background: white; color: #2d3436; padding: 15px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 6px solid #00b894; display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 0.9rem; z-index: 10000; transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .toast-box.active { transform: translateX(0); }
    .toast-box i { color: #00b894; font-size: 1.2rem; }
    #loader { position: fixed; inset: 0; background: #fff; z-index: 300; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 15px; }
    .spinner { width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top-color: #0984e3; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* UTILS */
    .leader-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0; font-size: 0.85rem; position: relative; z-index: 2; }
    .scroll-btn { position: fixed; bottom: 100px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: #0984e3; color: white; border: none; box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4); cursor: pointer; z-index: 90; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: transform 0.2s; }
    .scroll-btn:hover { transform: translateY(-5px); background: #74b9ff; }
    .notif-btn { background: rgba(0,0,0,0.05); border: none; width: 35px; height: 35px; border-radius: 50%; color: #636e72; cursor: pointer; font-size: 1.1rem; transition: 0.2s; position: relative; display: flex; align-items: center; justify-content: center; }
    .notif-btn:hover { background: rgba(0,0,0,0.1); color: #0984e3; }
    .notif-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #ff7675; border-radius: 50%; border: 2px solid white; display: none; }
    .notif-badge.show { display: block; }
    .notif-dropdown { position: absolute; top: 55px; right: 0; width: 320px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 0; display: none; flex-direction: column; overflow: hidden; color: #2d3436; animation: slideDown 0.2s ease; z-index: 200; }
    .notif-dropdown.active { display: flex; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .notif-header { padding: 15px; background: #f3f4f6; border-bottom: 1px solid #dfe6e9; font-weight: 800; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
    .notif-list { max-height: 300px; overflow-y: auto; }
    .notif-item { padding: 12px 15px; border-bottom: 1px solid #f1f2f6; font-size: 0.8rem; }
    .notif-time { font-size: 0.7rem; color: #b2bec3; font-weight: 600; margin-bottom: 2px; }
    .notif-id { font-family: var(--font-mono); color: #0984e3; font-weight: 700; }
    .notif-detail { color: #636e72; margin-top: 2px; font-size: 0.75rem; }
    
    /* NAV */
    .bottom-nav { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 900; pointer-events: none; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .bottom-nav.nav-hidden { transform: translateY(150%); }
    .nav-pill { pointer-events: auto; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); padding: 6px; border-radius: 50px; display: flex; gap: 5px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5) inset; border: 1px solid rgba(255,255,255,0.3); }
    .nav-item { background: transparent; border: none; padding: 10px 24px; border-radius: 40px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #b2bec3; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }
    .nav-icon { font-size: 1.1rem; transition: transform 0.3s ease; }
    .nav-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; max-width: 0; opacity: 0; white-space: nowrap; transition: all 0.3s ease; }
    .nav-item.active { background: var(--grad-red); color: white; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3); padding-right: 20px; padding-left: 20px; }
    .nav-item.active .nav-label { max-width: 100px; opacity: 1; margin-left: 4px; }
    .nav-item.active .nav-icon { transform: scale(1.1); }
    .nav-item:hover:not(.active) { background: rgba(0,0,0,0.03); color: #636e72; }
    @media (max-width: 480px) { .bottom-nav { bottom: 15px; } .nav-pill { padding: 5px; } .nav-item { padding: 10px 18px; } }
    .view-section { animation: fadeInView 0.4s ease-out; }
    @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* GRAPH SPECIFIC CSS */
    .graph-controls { display: flex; justify-content: center; margin-bottom: 2rem; }
    .pill-box { display: flex; background: white; padding: 5px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .pill-btn { border: none; background: transparent; padding: 8px 20px; border-radius: 25px; font-weight: 700; color: #b2bec3; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
    .pill-btn.active { background: #0984e3; color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); }
    .graph-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem; }
    .graph-full { grid-column: 1 / -1; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .canvas-holder { width: 100%; height: 100%; }
    @media (max-width: 768px) { .graph-grid { grid-template-columns: 1fr; } }

  </style> 
</head>
<body>

  <div id="toastNotification" class="toast-box">
    <i class="fa-solid fa-circle-check"></i>
    <span id="toastMessage">Success</span>
  </div>

  <div id="loader">
    <div class="spinner"></div>
    <div style="font-weight: 700; color: #0984e3; letter-spacing: 1px;">SYNCING DATA...</div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-box">
      <div class="modal-title">Update Order</div>
      <label class="form-label" style="color:#636e72;">Status</label>
      <div class="input-group" style="margin-bottom:10px;">
          <select id="editStatus" class="gold-select" style="background:#f9fafb; color:#2d3436; border:1px solid #dfe6e9;" onchange="autoFillDate()">
            <option value="PENDING">PENDING</option>
            <option value="PAID">PAID</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
            <option value="">QUEUES (Blank)</option>
          </select>
          <i class="fa-solid fa-tag input-icon" style="color:#b2bec3;"></i>
      </div>
      <label class="form-label" style="color:#636e72;">Filled Date</label>
      <div class="input-group">
          <input type="text" id="editFilled" class="gold-input" style="background:#f9fafb; color:#2d3436; border:1px solid #dfe6e9;" placeholder="DD/MM/YYYY">
          <i class="fa-solid fa-pen-nib input-icon" style="color:#b2bec3;"></i>
      </div>
      <label class="form-label" style="color:#636e72;">Paid Date</label>
      <div class="input-group">
          <input type="text" id="editPaid" class="gold-input" style="background:#f9fafb; color:#2d3436; border:1px solid #dfe6e9;" placeholder="DD/MM/YYYY">
          <i class="fa-solid fa-calendar-check input-icon" style="color:#b2bec3;"></i>
      </div>
      <label class="form-label" style="color:#636e72;">Remarks (Timeline)</label>
      <div class="input-group">
          <textarea id="editRemarks" class="gold-input" rows="3" style="background:#f9fafb; color:#2d3436; border:1px solid #dfe6e9; padding-left:12px;"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="modal-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-save" id="saveBtn" onclick="saveChanges()">Save Update</button>
      </div>
    </div>
  </div>

  <header class="app-header">
    <div class="header-left">
        <img src="https://drive.google.com/thumbnail?id=1IgeL0FRaPXfpmnBEh7mKdpOa2Pgeqdn2&sz=w200" class="logo-img" alt="Logo">
        <div class="logo-container">
            <div class="logo">PREORDER</div>
            <div class="meta-bar">ADMIN DASHBOARD</div>
        </div>
    </div>
    <div class="header-actions">
        <div class="status-pill"><div class="pulsing-dot"></div> ADMIN MODE</div>
        <div style="position:relative;">
            <button class="notif-btn" onclick="toggleNotifs()">
                <i class="fa-solid fa-bell"></i>
                <div id="notifBadge" class="notif-badge"></div>
            </button>
            <div id="notifPanel" class="notif-dropdown">
                <div class="notif-header">
                    <span>AUDIT LOGS</span>
                    <i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="toggleNotifs()"></i>
                </div>
                <div id="notifList" class="notif-list">
                    <div style="padding:20px; text-align:center; color:#b2bec3;">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>
  </header>

  <div class="main-layout">
    <aside style="display: flex; flex-direction: column; gap: 1.5rem;">
      <div class="gold-card">
        <div class="gold-card-bg"><i class="fa-solid fa-magnifying-glass wm-sidebar"></i></div>
        <label class="form-label">Search</label>
        <div class="input-group">
            <i class="fa-solid fa-magnifying-glass input-icon"></i>
            <input type="text" id="searchInput" class="gold-input" placeholder="ID or Name..." onkeyup="handleSearchKey()">
            <i class="fa-solid fa-circle-xmark clear-icon" id="searchClearBtn" onclick="clearSearch()"></i>
        </div>
      </div>
      
      <div class="gold-card">
        <div class="gold-card-bg"><i class="fa-solid fa-filter wm-sidebar"></i></div>
        <label class="form-label">Filters</label>
        <div class="input-group">
            <i class="fa-solid fa-handshake input-icon"></i>
            <select id="mediatorSelect" class="gold-select" onchange="applyFilters()"><option value="All">All Mediators</option></select>
            <i class="fa-solid fa-chevron-down input-arrow"></i>
        </div>
        <div class="input-group">
            <i class="fa-solid fa-tags input-icon"></i>
            <select id="statusSelect" class="gold-select" onchange="applyFilters()">
                <option value="All">All Statuses</option>
                <option value="PAID">Paid</option>
                <option value="PENDING">Pending</option>
                <option value="WARNING">Warning</option>
                <option value="QUEUES">QUEUES</option>
            </select>
            <i class="fa-solid fa-chevron-down input-arrow"></i>
        </div>
        <div class="input-group">
            <i class="fa-solid fa-calendar-days input-icon"></i>
            <select id="monthSelect" class="gold-select" onchange="applyFilters()"><option value="All">All Months</option></select>
            <i class="fa-solid fa-chevron-down input-arrow"></i>
        </div>
        <div class="input-group">
            <i class="fa-solid fa-layer-group input-icon"></i>
            <select id="typeSelect" class="gold-select" onchange="applyFilters()">
                <option value="All">All Types</option>
                <option value="LESS">Less Orders (Deducted)</option>
                <option value="COMMISSION">Commission Orders</option>
                <option value="FULL">Full Refund Orders</option>
            </select>
            <i class="fa-solid fa-chevron-down input-arrow"></i>
        </div>
        <label class="form-label" style="margin-top: 15px;">Sort Order</label>
        <div class="input-group">
            <i class="fa-solid fa-arrow-down-wide-short input-icon"></i>
            <select id="sortSelect" class="gold-select" onchange="applyFilters()">
                <option value="DESC">Newest First (Descending)</option>
                <option value="ASC">Oldest First (Ascending)</option>
            </select>
            <i class="fa-solid fa-chevron-down input-arrow"></i>
        </div>
      </div>

      <div class="gold-card">
        <div class="gold-card-bg"><i class="fa-solid fa-trophy wm-sidebar"></i></div>
        <label class="form-label">Leaderboard</label>
        <div id="leaderboardList" style="position: relative; z-index: 2;"></div>
      </div>
      <button class="btn-gold" onclick="downloadCSV()">
          <i class="fa-solid fa-file-csv"></i> Download CSV
      </button>
    </aside>

    <main style="display: flex; flex-direction: column; gap: 2rem;">
      <div id="view-home" class="view-section active-view">
        <div class="stats-grid">
            <div class="stat-card">
            <div class="gold-card-bg"><i class="fa-solid fa-boxes-stacked wm-stat"></i></div>
            <div class="stat-title">Orders</div><div class="stat-value" id="statOrders">0</div>
            </div>
            <div class="stat-card">
            <div class="gold-card-bg"><i class="fa-solid fa-wallet wm-stat"></i></div>
            <div class="stat-title">Amount</div><div class="stat-value" id="statTotalValue">‚Çπ0</div>
            </div>
            <div class="stat-card">
            <div class="gold-card-bg"><i class="fa-solid fa-scissors wm-stat"></i></div>
            <div class="stat-title">Deducted</div><div class="stat-value" id="statDeducted">‚Çπ0</div>
            </div>
            <div class="stat-card">
            <div class="gold-card-bg"><i class="fa-solid fa-rotate-left wm-stat"></i></div>
            <div class="stat-title">Refundable</div><div class="stat-value" id="statRefundable">‚Çπ0</div>
            </div>
            <div class="stat-card">
            <div class="gold-card-bg"><i class="fa-solid fa-chart-line wm-stat"></i></div>
            <div class="stat-title">Commission</div><div class="stat-value" id="statCommission">‚Çπ0</div>
            </div>
        </div>
        <div id="ordersGridHome" class="orders-grid" style="margin-top: 2rem;"></div>
      </div>

      <div id="view-graph" class="view-section" style="display: none;">
          <div class="graph-controls">
              <div class="pill-box">
                  <button class="pill-btn active" onclick="updateGraphRange('7')">7 Days</button>
                  <button class="pill-btn" onclick="updateGraphRange('30')">30 Days</button>
                  <button class="pill-btn" onclick="updateGraphRange('ALL')">All Time</button>
              </div>
          </div>

          <div class="stats-grid" id="graphKpiGrid">
              </div>

          <div class="graph-grid">
              <div class="gold-card graph-full" style="background: white; color: #2d3436; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem; font-size: 0.9rem; color: #636e72;">REVENUE OVER TIME</h3>
                  <div class="chart-container">
                      <canvas id="revenueChart"></canvas>
                  </div>
              </div>
              <div class="gold-card" style="background: white; color: #2d3436; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem; font-size: 0.9rem; color: #636e72;">ORDER VELOCITY</h3>
                  <div class="chart-container">
                      <canvas id="velocityChart"></canvas>
                  </div>
              </div>
              <div class="gold-card" style="background: white; color: #2d3436; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem; font-size: 0.9rem; color: #636e72;">STATUS DISTRIBUTION</h3>
                  <div class="chart-container" style="max-height: 250px;">
                      <canvas id="statusChart"></canvas>
                  </div>
              </div>
          </div>
      </div>

      <div id="view-list" class="view-section" style="display: none;">
          <div style="margin-bottom: 1rem; font-weight: 700; color: #636e72;">FULL ORDER REGISTRY</div>
          <div id="ordersGridList" class="orders-grid"></div>
      </div>

      <footer style="text-align: center; color: #b2bec3; font-size: 0.8rem; margin-top: 20px; font-weight: 600; letter-spacing: 1px;">
        &copy; PREORDER ALL RIGHTS RESERVED
      </footer>
    </main>
  </div>

  <button class="scroll-btn" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
    <i class="fa-solid fa-arrow-up"></i>
  </button>

  <nav class="bottom-nav" id="mainNavBar">
    <div class="nav-pill">
      <button class="nav-item active" onclick="switchTab(event, 'home')">
        <div class="nav-icon"><i class="fa-solid fa-house"></i></div>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-item" onclick="switchTab(event, 'graph')">
        <div class="nav-icon"><i class="fa-solid fa-chart-simple"></i></div>
        <span class="nav-label">Graph</span>
      </button>
      <button class="nav-item" onclick="switchTab(event, 'list')">
        <div class="nav-icon"><i class="fa-solid fa-list-check"></i></div>
        <span class="nav-label">List</span>
      </button>
    </div>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

<style>
  /* SAAS MODAL STYLES */
  .saas-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
  .saas-overlay.active { display: flex; animation: fadeIn 0.3s; }
  .saas-box { background: white; width: 90%; max-width: 420px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: center; position: relative; border-top: 6px solid #0984e3; font-family: 'Poppins', sans-serif; }
  .saas-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
  .saas-title { font-size: 1.4rem; font-weight: 800; color: #2d3436; margin-bottom: 10px; }
  .saas-text { font-size: 0.9rem; color: #636e72; line-height: 1.5; margin-bottom: 20px; }
  .saas-input { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; font-size: 1rem; margin-bottom: 15px; outline: none; transition: 0.2s; }
  .saas-input:focus { border-color: #0984e3; }
  .saas-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; margin-bottom: 10px; transition: 0.2s; text-transform: uppercase; }
  .saas-btn-primary { background: #0984e3; color: white; box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3); }
  .saas-btn-primary:hover { transform: translateY(-2px); }
  .saas-btn-sec { background: #f1f2f6; color: #2d3436; }
  .saas-btn-sec:hover { background: #dfe6e9; }
  .saas-email-box { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; font-family: monospace; font-weight: 700; margin-bottom: 15px; border: 1px dashed #ffeeba; user-select: all; font-size: 0.8rem; word-break: break-all; }
  .saas-trust { font-size: 0.7rem; color: #b2bec3; margin-top: 15px; border-top: 1px solid #f1f2f6; padding-top: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }
  .saas-close { position: absolute; top: 15px; right: 15px; cursor: pointer; color: #b2bec3; font-size: 1.2rem; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div id="saasOverlay" class="saas-overlay">
  <div id="saasContent" class="saas-box">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<script>
    // =================================================================
    // ENTERPRISE CONFIGURATION
    // =================================================================
    
    const USE_DEMO_MODE = false; // Set to FALSE for Production
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwd6UhDaIPTjinqpa2AAYX_b5VShScPZFfyLxCmrIxW8V_Gei937ljKm9ZDsq3Hvuzxjw/exec"; // <--- PASTE NEW URL HERE
    const SCRIPT_EMAIL = "searchki25y@gmail.com"; // <--- PASTE YOUR EMAIL HERE
    const CHUNK_SIZE = 400; 

    // =================================================================
    // GLOBAL STATE
    // =================================================================
    let CURRENT_USER = localStorage.getItem('preorder_user') || "";
    let URL_USER = "<?= urlUser ?>"; // Injected by Backend
    
    let allData = [];
    let filteredData = [];
    let currentEditId = null;
    let isSyncing = false;
    let chartInstances = {}; 
    let locallyModified = new Set(); 

    // =================================================================
    // SAAS POPUP SYSTEM
    // =================================================================
    const POPUPS = {
      WELCOME: {
        icon: 'üëã', title: 'Welcome to PREORDER',
        text: 'This dashboard helps you track and manage your preorder refunds in one place. To continue, please enter your registered username.',
        html: `<button class="saas-btn saas-btn-primary" onclick="showPopup('LOGIN')">Continue with Username</button>
               <div class="saas-trust"><i class="fa-solid fa-lock"></i> Your data stays in your own Google Sheet.</div>`
      },
      LOGIN: {
        icon: 'üîê', title: 'Enter Your Username',
        text: 'Please enter the username provided by admin (e.g., rahul_preorder).',
        html: `<input type="text" id="loginInput" class="saas-input" placeholder="Your username">
               <button class="saas-btn saas-btn-primary" onclick="attemptLogin()">Continue</button>
               <button class="saas-btn saas-btn-sec" onclick="showPopup('WELCOME')">Back</button>`
      },
      CONNECT_OPT: {
        icon: 'üîó', title: 'Connect Your Data',
        text: 'Choose how you want to connect this dashboard with your data.',
        html: `<button class="saas-btn saas-btn-primary" onclick="showPopup('SHEET_SETUP')">üîó Connect via Sheet Link</button>
               <button class="saas-btn saas-btn-sec" onclick="alert('Use the link provided by your Admin.')">‚ö° Use Web App Link</button>
               <button class="saas-btn saas-btn-sec" onclick="closePopup()">Cancel</button>`
      },
      SHEET_SETUP: {
        icon: 'üìÑ', title: 'Connect Google Sheet',
        text: 'Please share your Google Sheet once with the email below (Editor access) and paste the link.',
        html: `<div class="saas-email-box">${SCRIPT_EMAIL}</div>
               <input type="text" id="sheetUrlInput" class="saas-input" placeholder="Paste Google Sheet Link here...">
               <button class="saas-btn saas-btn-primary" onclick="submitSheetLink()">Connect Sheet</button>
               <button class="saas-btn saas-btn-sec" onclick="showPopup('CONNECT_OPT')">Back</button>
               <div class="saas-trust"><i class="fa-solid fa-lock"></i> We only read/update your file.</div>`
      },
      PERMISSION_ERR: {
        icon: '‚õî', title: 'Sheet Access Required',
        text: 'We are unable to access your Google Sheet. Please make sure you have shared it.',
        html: `<div class="saas-email-box">${SCRIPT_EMAIL}</div>
               <button class="saas-btn saas-btn-primary" onclick="location.reload()">I Have Shared, Retry</button>`
      },
      NO_SHEET: {
        icon: '‚ö†Ô∏è', title: 'Setup Required',
        text: 'Your account is active, but no Google Sheet is linked yet.',
        html: `<button class="saas-btn saas-btn-primary" onclick="showPopup('SHEET_SETUP')">Connect My Sheet</button>
               <button class="saas-btn saas-btn-sec" onclick="logoutUser()">Logout</button>`
      },
      PAUSED: {
        icon: '‚è∏Ô∏è', title: 'Account Paused',
        text: 'Your access has been paused. Please contact admin.',
        html: `<button class="saas-btn saas-btn-primary" onclick="window.open('mailto:${SCRIPT_EMAIL}')">Contact Admin</button>
               <button class="saas-btn saas-btn-sec" onclick="logoutUser()">Logout</button>`
      },
      BLOCKED: {
        icon: 'üö´', title: 'Access Blocked',
        text: 'Your account has been blocked. Reach out to admin if this is a mistake.',
        html: `<button class="saas-btn saas-btn-sec" onclick="logoutUser()">Close</button>`
      },
      EXPIRED: {
        icon: '‚è≥', title: 'Plan Expired',
        text: 'Your plan has expired. Please renew to continue.',
        html: `<button class="saas-btn saas-btn-primary" onclick="window.open('mailto:${SCRIPT_EMAIL}')">Renew Now</button>
               <button class="saas-btn saas-btn-sec" onclick="logoutUser()">Logout</button>`
      }
    };

    function showPopup(key) {
      const config = POPUPS[key];
      const el = document.getElementById('saasContent');
      el.innerHTML = `
        <div class="saas-icon">${config.icon}</div>
        <div class="saas-title">${config.title}</div>
        <div class="saas-text">${config.text}</div>
        ${config.html}
      `;
      document.getElementById('saasOverlay').classList.add('active');
    }

    function closePopup() { document.getElementById('saasOverlay').classList.remove('active'); }

    function attemptLogin() {
      const val = document.getElementById('loginInput').value.trim();
      if (val.length < 3) { alert("Invalid Username"); return; }
      CURRENT_USER = val;
      localStorage.setItem('preorder_user', CURRENT_USER);
      closePopup();
      location.reload();
    }

    function logoutUser() {
      localStorage.removeItem('preorder_user');
      CURRENT_USER = "";
      location.reload();
    }

    async function submitSheetLink() {
      const url = document.getElementById('sheetUrlInput').value;
      const btn = document.querySelector('.saas-btn-primary');
      const orgText = btn.innerText;
      btn.innerText = "Verifying...";
      try {
        const res = await apiCall('registerSheet', { sheetUrl: url });
        if (res.success) {
          showToast("Sheet Connected Successfully!");
          closePopup();
          location.reload();
        }
      } catch (e) { console.error(e); } finally { btn.innerText = orgText; }
    }

    // =================================================================
    // API & INIT LAYER
    // =================================================================

    // Init System on Load
    window.onload = function() {
        // Mode B Check
        if (URL_USER && URL_USER.length > 2) {
            CURRENT_USER = URL_USER;
            localStorage.setItem('preorder_user', CURRENT_USER);
            window.history.replaceState({}, document.title, "/"); // Clean URL
        }

        if (!CURRENT_USER) {
            showPopup('WELCOME');
        } else {
            // Setup UI
            const meta = document.querySelector('.meta-bar');
            if(meta) meta.innerHTML = `USER: ${CURRENT_USER.toUpperCase()}`;
            
            const headerLeft = document.querySelector('.header-left');
            if(headerLeft) {
                headerLeft.style.cursor = "pointer";
                headerLeft.onclick = () => showPopup('CONNECT_OPT');
            }

            // Start Sync
            initSystem();
        }
    };

    async function apiCall(action, payload = null, retries = 3) {
      if(USE_DEMO_MODE) return new Promise(r => setTimeout(() => r(action === 'getData' ? {rows:[], hasMore:false} : "SUCCESS"), 300));
      
      const bodyData = { action: action, payload: payload, username: CURRENT_USER };

      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify(bodyData)
          });
          const json = await response.json();
          
          if(json.error) {
            handleBackendError(json);
            throw new Error(json.error);
          }
          return json;

        } catch (e) {
          if(e.message === "Failed to fetch") { showToast("Network Error"); }
          if(i === retries - 1) throw e;
          await new Promise(r => setTimeout(r, 1000)); 
        }
      }
    }

    function handleBackendError(json) {
        const code = json.error;
        if (code === "USER_NOT_FOUND" || code === "AUTH_MISSING") { logoutUser(); showPopup('LOGIN'); }
        else if (code === "ACCOUNT_PAUSED") showPopup('PAUSED');
        else if (code === "ACCOUNT_BLOCKED") showPopup('BLOCKED');
        else if (code === "PLAN_EXPIRED") { POPUPS.EXPIRED.text = `Plan expired on ${json.expiryDate}.`; showPopup('EXPIRED'); }
        else if (code === "NO_SHEET") showPopup('NO_SHEET');
        else if (code === "PERMISSION_DENIED" || code === "PERMISSION_LOST") showPopup('PERMISSION_ERR');
        else showToast("Error: " + (json.message || code));
    }

    // =================================================================
    // CORE DASHBOARD LOGIC (Reused & Cleaned)
    // =================================================================

    function initSystem() {
      fetchDataChunked();
      setInterval(() => { if(!USE_DEMO_MODE) apiCall('serverPing').catch(e=>{}); }, 300000);
    }

    async function fetchDataChunked() {
      if(isSyncing) return;
      isSyncing = true;
      const loader = document.getElementById('loader');
      if(allData.length === 0) loader.style.display = 'flex';
      
      let page = 1;
      let hasMore = true;

      try {
        while (hasMore) {
          const result = await apiCall('getData', { page: page, limit: CHUNK_SIZE });
          
          if (result.rows && result.rows.length > 0) {
            const chunkStartRow = result.startRow || ((page - 1) * CHUNK_SIZE + 2);
            const mappedChunk = result.rows.map((row, idx) => mapRowToObject(row, chunkStartRow + idx)).filter(item => item.id);

            mappedChunk.forEach(newItem => {
                const existingIdx = allData.findIndex(d => d.id === newItem.id);
                if(existingIdx > -1) {
                    if(!locallyModified.has(newItem.id)) allData[existingIdx] = newItem; 
                } else {
                    allData.push({ ...newItem, logicStatus: getLogicStatus(newItem) });
                }
            });
          }

          if (page === 1) {
              loader.style.display = 'none';
              populateDropdowns();
              initGraph();
          }
          applyFilters(true);
          hasMore = result.hasMore;
          page++;
        }
        applyFilters(); 
        updateGraphRange('7'); 
        showToast("Sync Complete: " + allData.length + " Orders");
      } catch (e) {
        if(allData.length === 0 && !e.message.includes("USER")) alert("Sync Failed: " + e.message); 
      } finally {
        loader.style.display = 'none';
        isSyncing = false;
      }
    }

    // --- HELPER FUNCTIONS ---
    function mapRowToObject(row, sheetRowIndex) {
      return {
        id:           row[0]  || "",  
        reviewer:     row[2]  || "N/A",            
        product:      row[3]  || "N/A",            
        dealType:     row[4]  || "General",        
        total:        parseCurrencyStr(row[5]),       
        deducted:     parseCurrencyStr(row[6]),       
        commission:   parseCurrencyStr(row[7]),       
        refundable:   parseCurrencyStr(row[8]),       
        deliveryDate: row[9]  || "",               
        filledDate:   row[10] || "",
        refundDate:   row[11] || "",               
        paidDate:     row[12] || "",               
        remarks:      row[13] || "",               
        formLink:     row[14] || "",               
        mediator:     row[15] || "N/A",            
        phone:        row[16] || "",               
        status:       (row[18] || "").toUpperCase().trim(),
        rowIndex:     sheetRowIndex, 
        logicStatus:  "VALID" 
      };
    }
    
    function parseCurrencyStr(val) { if (!val) return 0; var num = parseFloat(String(val).replace(/[^0-9.-]+/g,"")); return isNaN(num) ? 0 : num; }
    
    function getLogicStatus(item) {
        let logicStatus = "VALID";
        if (item.paidDate && item.status !== "PAID") logicStatus = "ERROR";
        if (!item.filledDate && item.status === "PAID" && logicStatus !== "ERROR") logicStatus = "WARNING";
        return logicStatus;
    }

    // --- UI RENDERING ---
    function renderCards() {
      const isListView = document.getElementById('view-list').style.display !== 'none';
      const targetGridId = isListView ? 'ordersGridList' : 'ordersGridHome';
      const grid = document.getElementById(targetGridId);
      if (!grid) return; 
      
      grid.innerHTML = "";
      if(filteredData.length === 0) { grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#999;font-weight:700;">No Orders Found</div>`; return; }
      
      const renderLimit = filteredData.length > 200 ? 100 : filteredData.length;
      let htmlBuffer = "";
      for(let i=0; i<renderLimit; i++) { htmlBuffer += generateCardHTML(filteredData[i], i); }
      grid.innerHTML = htmlBuffer;

      if(filteredData.length > renderLimit) {
         grid.innerHTML += `<div style="grid-column:1/-1;text-align:center;padding:10px;"><button class="link-btn-external" onclick="renderRestCards('${targetGridId}')">Load Remaining ${filteredData.length - renderLimit} Cards</button></div>`;
      }
    }
    
    function renderRestCards(gridId) {
        const grid = document.getElementById(gridId);
        grid.lastElementChild.remove();
        let htmlBuffer = "";
        for(let i=100; i<filteredData.length; i++) { htmlBuffer += generateCardHTML(filteredData[i], i); }
        grid.insertAdjacentHTML('beforeend', htmlBuffer);
    }

    function generateCardHTML(item, index) {
        let themeClass = "card-queues", textClass = "text-queues", displayStatus = item.status || "QUEUES";
        if (item.status === "PAID") { themeClass = "card-paid"; textClass = "text-paid"; } 
        else if (item.status === "PENDING") { themeClass = "card-pending"; textClass = "text-pend"; } 
        else if (item.status === "WARNING") { themeClass = "card-error"; textClass = "text-err"; }
        if (item.logicStatus === "ERROR") { themeClass = "card-error"; textClass = "text-err"; displayStatus = "ERROR (Check)"; }

        let middleRow = "";
        if (item.deducted > 0) middleRow = `<div class="money-row"><span>Deducted</span><span style="color:#ffcccc; font-weight:700;">-${fmt(item.deducted)}</span></div>`;
        else if (item.commission > 0) middleRow = `<div class="money-row"><span>Commission</span><span style="color:#55efc4; font-weight:700;">+${fmt(item.commission)}</span></div>`;
        
        let formBtn = "", waBtn = "";
        if(item.formLink && item.formLink.trim().length > 5) formBtn = `<a href="${item.formLink}" target="_blank" class="link-btn-external"><i class="fa-solid fa-arrow-up-right-from-square"></i> OPEN FORM</a>`;
        if(item.phone && item.phone.trim().length > 5) {
            const msg = `Hi _${item.mediator}_, \uD83D\uDC4B\n\n\uD83D\uDCC3 Refund Reminder\n\n*\uD83D\uDCE6 Order ID: \`${item.id}\`*\nTotal Due: ${fmt(item.refundable)}\n\n~PREORDER`;
            const waLink = `https://wa.me/${item.phone}?text=${encodeURIComponent(msg)}`;
            waBtn = `<a href="${waLink}" target="_blank" class="btn-icon btn-wa-icon"><i class="fa-solid fa-bell"></i></a>`;
        }
        
        const badgeStyle = `display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.25); padding: 5px 10px; border-radius: 8px; font-size: 0.65rem; font-weight: 700; backdrop-filter: blur(4px); color: white; white-space: nowrap; height: 26px; border: 1px solid rgba(255,255,255,0.1);`;

        return `
        <div id="card-wrapper-${item.id}" class="order-card ${themeClass}">
        <div class="card-content">
            <div class="card-head">
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="${badgeStyle}"><i class="fa-solid fa-hashtag"></i> ORDER ${index + 1}</div>
                    <div style="${badgeStyle}"><i class="fa-solid fa-user"></i> ${item.reviewer}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                    <div style="${badgeStyle}; cursor:pointer; font-family:monospace;" onclick="copy('${item.id}')"><i class="fa-solid fa-fingerprint"></i> ${item.id}</div>
                    <div style="${badgeStyle}"><i class="fa-solid fa-tag"></i> ${item.dealType}</div>
                </div>
                <i class="fa-solid fa-file-invoice head-echo"></i>
            </div>
            <div class="glass-panel"><div class="prod-name"><i class="fa-solid fa-mobile-screen"></i> &nbsp; ${item.product}</div></div>
            <div class="glass-panel">
            <div class="money-row"><span>Total</span><span>${fmt(item.total)}</span></div>
            ${middleRow}
            <div class="total-row"><span>REFUNDABLE</span><span>${fmt(item.refundable)}</span></div>
            </div>
            <div class="glass-panel">
            <div class="date-grid">
                <div class="date-item"><span>DELIVERED</span><div><i class="fa-solid fa-truck-fast"></i> ${item.deliveryDate||'-'}</div></div>
                <div class="date-item"><span>FILLED</span><div><i class="fa-solid fa-pen-nib"></i> ${item.filledDate||'-'}</div></div>
                <div class="date-item"><span>REFUND</span><div><i class="fa-solid fa-clock-rotate-left"></i> ${item.refundDate||'-'}</div></div>
                <div class="date-item"><span>PAID</span><div><i class="fa-solid fa-calendar-check"></i> ${item.paidDate||'-'}</div></div>
            </div>
            </div>
            <div class="glass-panel"><div class="memo-text"><i class="fa-solid fa-quote-left"></i> &nbsp; ${item.remarks||'No Timeline Info'}</div></div>
            <div class="action-row">
            <div class="status-pill-card ${textClass}">${displayStatus}</div>
            <div class="icon-group">${waBtn}<button class="btn-icon btn-edit-icon" onclick="openEditModal('${item.id}')"><i class="fa-solid fa-pen"></i></button></div>
            ${formBtn}
            </div>
        </div>
        </div>`;
    }

    // --- UTILS & INTERACTIONS ---
    function autoFillDate() { if(document.getElementById('editStatus').value === "PAID") { const d=new Date(); document.getElementById('editPaid').value = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; } }
    function handleSearchKey() { document.getElementById('searchClearBtn').style.display = document.getElementById('searchInput').value.length > 0 ? 'block' : 'none'; applyFilters(); }
    function clearSearch() { document.getElementById('searchInput').value = ''; document.getElementById('searchClearBtn').style.display = 'none'; applyFilters(); }
    
    function applyFilters(isBackgroundSync = false) {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const mediator = document.getElementById('mediatorSelect').value;
      const status = document.getElementById('statusSelect').value;
      const month = document.getElementById('monthSelect').value;
      const type = document.getElementById('typeSelect').value; 
      const sortOrder = document.getElementById('sortSelect').value;

      filteredData = allData.filter(item => {
        const mSearch = item.id.toLowerCase().includes(search) || item.reviewer.toLowerCase().includes(search) || item.product.toLowerCase().includes(search);
        const mMediator = (mediator === "All") || (item.mediator === mediator);
        let mStatus = true;
        if(status !== "All") mStatus = status === "QUEUES" ? (item.status === "" || item.status === null) : (item.status === status);
        const mMonth = (month === "All") || (getCleanMonth(item.deliveryDate) === month);
        let mType = true;
        if(type === "LESS") mType = (item.deducted > 0);
        else if (type === "COMMISSION") mType = (item.commission > 0);
        else if (type === "FULL") mType = (item.deducted === 0 && item.commission === 0);

        return mSearch && mMediator && mStatus && mMonth && mType;
      });

      filteredData.sort((a, b) => {
        const dateA = parseDateToTs(a.deliveryDate), dateB = parseDateToTs(b.deliveryDate);
        return sortOrder === 'DESC' ? dateB - dateA : dateA - dateB;
      });

      renderStats();
      renderCards();
      renderLeaderboard();
      if(document.getElementById('view-graph').style.display === 'block') updateGraphRange(document.querySelector('.pill-btn.active').innerText.includes('7') ? '7' : '30');
    }

    function renderStats() {
      let tVal=0, tRef=0, tComm=0, tDed=0;
      filteredData.forEach(d => { tVal += d.total; tRef += d.refundable; tComm += d.commission; tDed += d.deducted; });
      document.getElementById("statOrders").innerText = filteredData.length;
      document.getElementById("statTotalValue").innerText = fmt(tVal);
      document.getElementById("statRefundable").innerText = fmt(tRef);
      document.getElementById("statCommission").innerText = fmt(tComm);
      document.getElementById("statDeducted").innerText = fmt(tDed);
    }

    function renderLeaderboard() {
      const map = {};
      filteredData.forEach(d => { if(d.mediator && d.mediator !== "N/A") { map[d.mediator] = (map[d.mediator]||0) + 1; }});
      const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
      document.getElementById('leaderboardList').innerHTML = sorted.map((i,x)=>`<div class="leader-row"><span style="color:white; opacity:0.8;">#${x+1} ${i[0]}</span><span style="font-weight:700;">${i[1]} Orders</span></div>`).join('');
    }

    function populateDropdowns() {
      const prevMed = document.getElementById('mediatorSelect').value;
      const prevMonth = document.getElementById('monthSelect').value;
      const mediators = [...new Set(allData.map(d => d.mediator))].sort();
      const medSelect = document.getElementById('mediatorSelect');
      medSelect.innerHTML = '<option value="All">All Mediators</option>';
      mediators.forEach(m => { if(m && m!="N/A") { let opt = document.createElement('option'); opt.value = m; opt.textContent = m; medSelect.appendChild(opt); }});
      if(mediators.includes(prevMed)) medSelect.value = prevMed;

      const months = new Set();
      allData.forEach(d => { const m = getCleanMonth(d.deliveryDate); if (m !== "Invalid") months.add(m); });
      const monSelect = document.getElementById('monthSelect');
      monSelect.innerHTML = '<option value="All">All Months</option>';
      [...months].sort().forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.textContent = m; monSelect.appendChild(opt); });
      if(months.has(prevMonth)) monSelect.value = prevMonth;
    }

    function openEditModal(id) {
      const order = allData.find(d => d.id === id);
      if(!order) return;
      currentEditId = id;
      document.getElementById('editStatus').value = order.status;
      document.getElementById('editFilled').value = order.filledDate;
      document.getElementById('editPaid').value = order.paidDate; 
      document.getElementById('editRemarks').value = order.remarks;
      document.getElementById('editModal').classList.add('active');
    }
    function closeModal() { document.getElementById('editModal').classList.remove('active'); currentEditId = null; }

    function saveChanges() {
      if(!currentEditId) return;
      const btn = document.getElementById('saveBtn');
      const oldText = btn.innerText; btn.innerText = "Saving...";
      
      const newStatus = document.getElementById('editStatus').value;
      const newFilled = document.getElementById('editFilled').value;
      const newPaid = document.getElementById('editPaid').value;
      const newRemarks = document.getElementById('editRemarks').value;
      const updates = { id: currentEditId, status: newStatus, filledDate: newFilled, paidDate: newPaid, remarks: newRemarks };
      
      locallyModified.add(currentEditId);

      const idx = allData.findIndex(d => d.id === currentEditId);
      const oldDataSnapshot = { ...allData[idx] }; 
      
      if(idx > -1) {
        allData[idx].status = newStatus; allData[idx].filledDate = newFilled; 
        allData[idx].paidDate = newPaid; allData[idx].remarks = newRemarks;
        allData[idx].logicStatus = getLogicStatus(allData[idx]);
      }
      
      applyFilters();
      closeModal(); showToast("Order Updated!"); btn.innerText = oldText;

      apiCall('updateOrder', updates).then(res => {
          if(!USE_DEMO_MODE && res !== "SUCCESS") { 
            alert("Sync Error: " + res); allData[idx] = oldDataSnapshot; applyFilters(); locallyModified.delete(currentEditId);
          }
        }).catch(e => { alert("Network Error"); allData[idx] = oldDataSnapshot; applyFilters(); locallyModified.delete(currentEditId); });
    }

    async function downloadCSV() {
      const btn = document.querySelector('.btn-gold');
      const orgText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> BUILDING CSV...';
      try {
        let csvContent = ""; let page = 0; let hasMore = true;
        while(hasMore) {
           const res = await apiCall('getCsvChunk', { page: page });
           if(res.error) throw new Error(res.error);
           if(res.csv) csvContent += (csvContent ? "\n" : "") + res.csv;
           hasMore = res.hasMore; page++;
           btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> PART ${page}...`;
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob); link.download = "Preorder_Full_Export.csv";
        link.click(); showToast("Export Complete!");
      } catch(e) { alert("Export Failed"); } finally { btn.innerHTML = orgText; }
    }

    function toggleNotifs() { const p = document.getElementById('notifPanel'); if(!p.classList.contains('active')) { p.classList.add('active'); fetchLogs(); document.getElementById('notifBadge').classList.remove('show'); } else { p.classList.remove('active'); } }
    function fetchLogs() { if(USE_DEMO_MODE) return; apiCall('getRecentLogs').then(renderLogs); }
    function renderLogs(logs) {
        const list = document.getElementById('notifList');
        if(!logs || logs.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center; color:#b2bec3;">No recent edits.</div>'; return; }
        list.innerHTML = logs.map(l => `<div class="notif-item"><div class="notif-time">${l[0]}</div><div class="notif-id">${l[1]}</div><div class="notif-detail">${l[2]}</div></div>`).join('');
    }

    // --- CHART LOGIC ---
    function initGraph() {
        if(chartInstances['revenue']) return;
        chartInstances['revenue'] = new Chart(document.getElementById('revenueChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Revenue', data: [], borderColor: '#00b894', backgroundColor: 'rgba(0, 184, 148, 0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: { grid: {display:false} }, y: { grid: { color: 'rgba(0,0,0,0.05)' } } } } });
        chartInstances['velocity'] = new Chart(document.getElementById('velocityChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Orders', data: [], backgroundColor: '#0984e3', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: { grid: {display:false} }, y: { grid: {display:false} } } } });
        chartInstances['status'] = new Chart(document.getElementById('statusChart'), { type: 'doughnut', data: { labels: ['Paid', 'Pending', 'Warning', 'Queues'], datasets: [{ data: [0,0,0,0], backgroundColor: ['#00b894', '#ff7675', '#d63031', '#6c5ce7'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } } } });
    }

    function updateGraphRange(range) {
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
        if(event && event.target) event.target.classList.add('active');
        const now = new Date(), cutoff = new Date();
        if(range === '7') cutoff.setDate(now.getDate() - 7);
        if(range === '30') cutoff.setDate(now.getDate() - 30);
        if(range === 'ALL') cutoff.setFullYear(2020);
        
        const subset = allData.filter(d => parseDateToTs(d.deliveryDate) >= cutoff.getTime());
        const grouped = {}; let tRev=0, tOrd=subset.length, sPaid=0, sPend=0, sWarn=0, sQueue=0;

        subset.forEach(d => {
            if(!grouped[d.deliveryDate]) grouped[d.deliveryDate] = { rev:0, count:0 };
            grouped[d.deliveryDate].rev += d.total; grouped[d.deliveryDate].count++; tRev+=d.total;
            if(d.status==='PAID') sPaid++; else if(d.status==='PENDING') sPend++; else if(d.status==='WARNING') sWarn++; else sQueue++;
        });

        const sortedKeys = Object.keys(grouped).sort((a,b) => parseDateToTs(a) - parseDateToTs(b));
        if(chartInstances['revenue']) { chartInstances['revenue'].data.labels = sortedKeys.map(k=>k.substring(0,5)); chartInstances['revenue'].data.datasets[0].data = sortedKeys.map(k=>grouped[k].rev); chartInstances['revenue'].update(); }
        if(chartInstances['velocity']) { chartInstances['velocity'].data.labels = sortedKeys.map(k=>k.substring(0,5)); chartInstances['velocity'].data.datasets[0].data = sortedKeys.map(k=>grouped[k].count); chartInstances['velocity'].update(); }
        if(chartInstances['status']) { chartInstances['status'].data.datasets[0].data = [sPaid, sPend, sWarn, sQueue]; chartInstances['status'].update(); }

        document.getElementById('graphKpiGrid').innerHTML = `<div class="stat-card" style="background:var(--grad-blue)"><div class="stat-title">Period Revenue</div><div class="stat-value">${fmt(tRev)}</div></div><div class="stat-card" style="background:var(--grad-purple)"><div class="stat-title">Total Orders</div><div class="stat-value">${tOrd}</div></div><div class="stat-card" style="background:var(--grad-orange)"><div class="stat-title">Avg Value</div><div class="stat-value">${fmt(tOrd>0?tRev/tOrd:0)}</div></div>`;
    }

    function getCleanMonth(str) { if (!str || str.length < 5) return "Invalid"; const p = str.split('/'); return p.length === 3 ? `${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(p[1])-1]} ${p[2]}` : "Invalid"; }
    function parseDateToTs(str) { if(!str) return 0; const p = str.trim().split('/'); return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]).getTime() : 0; }
    function fmt(n) { return n.toLocaleString('en-IN', {style:'currency', currency:'INR', minimumFractionDigits:0}); }
    function copy(text) { navigator.clipboard.writeText(text).then(()=>showToast("Copied!")).catch(()=>prompt("Copy:", text)); }
    function showToast(msg) { const t = document.getElementById('toastNotification'); document.getElementById('toastMessage').innerText = msg; t.classList.add('active'); setTimeout(() => t.classList.remove('active'), 3000); }
    function switchTab(e, name) { document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); document.querySelectorAll('.view-section').forEach(v=>v.style.display='none'); document.getElementById('view-'+name).style.display='block'; if(name==='home'||name==='list') applyFilters(); else if(name==='graph') updateGraphRange('7'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
                  </script>
